{% extends "layouts/base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="card">
    <div class="card-body">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">

  <!-- Left side: New Student + Search -->
  <div class="d-flex align-items-center flex-wrap gap-2">

    <!-- Add Student Button -->
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStudentModal" id="addStudentBtn">
      Add Student
    </button>

    <!-- Search -->
    <div class="d-flex align-items-center gap-2">
      <input class="form-control"
             type="search"
             placeholder="Search Students..."
             id="searchInput"
             style="width: 260px;">
      <button class="btn btn-outline-primary" type="button" onclick="searchStudents()">Search</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="d-flex align-items-center flex-wrap gap-2">
    <span class="fw-bold me-1">Filter by:</span>

    <select class="form-select" id="programFilter" onchange="applyFilters()" style="width: 160px;">
      <option value="">All Programs</option>
    </select>

    <select class="form-select" id="yearFilter" onchange="applyFilters()" style="width: 140px;">
      <option value="">All Years</option>
      <option value="1st Year">1st Year</option>
      <option value="2nd Year">2nd Year</option>
      <option value="3rd Year">3rd Year</option>
      <option value="4th Year">4th Year</option>
      <option value="5th Year">5th Year</option>
    </select>

    <select class="form-select" id="genderFilter" onchange="applyFilters()" style="width: 140px;">
      <option value="">All Genders</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
  </div>

  <!-- Sort -->
  <select class="form-select" id="sortSelect" onchange="sortStudents()" style="width: 180px;">
    <option value="id">Sort by ID Number</option>
    <option value="first_name">Sort by First Name</option>
    <option value="last_name">Sort by Last Name</option>
    <option value="program">Sort by Program</option>
    <option value="year">Sort by Year</option>
    <option value="gender">Sort by Gender</option>
  </select>

</div>


  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead style="background-color: #456882; color: #D2C1B6;">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Photo</th>
          <th scope="col">ID Number</th>
          <th scope="col">Name</th>
          <th scope="col">Program</th>
          <th scope="col">Year</th>
          <th scope="col">Gender</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="students-tbody">
        <!-- Students will be loaded here via JS -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls">
      <!-- Pagination will be generated here via JS -->
    </ul>
  </nav>
    </div>
  </div>
</div>

<!-- ðŸŸ¢ Modal: Add Student -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="addStudentForm" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="addStudentIdYear" class="form-label">ID Year</label>
          <input type="number" class="form-control" id="addStudentIdYear" placeholder="e.g., 2025" value="2025">
        </div>
        <div class="mb-3">
          <label for="addStudentIdNumber" class="form-label">ID Number</label>
          <input type="text" class="form-control" id="addStudentIdNumber" placeholder="Auto-generated" readonly>
        </div>
        <div class="mb-3">
          <label for="addStudentFirstName" class="form-label">First Name</label>
          <input type="text" class="form-control" id="addStudentFirstName" placeholder="e.g., John">
        </div>
        <div class="mb-3">
          <label for="addStudentLastName" class="form-label">Last Name</label>
          <input type="text" class="form-control" id="addStudentLastName" placeholder="e.g., Doe">
        </div>
        <div class="mb-3">
          <label for="addStudentProgram" class="form-label">Program</label>
          <select class="form-control" id="addStudentProgram">
            <!-- Programs will be loaded here -->
          </select>
        </div>
        <div class="mb-3">
          <label for="addStudentYear" class="form-label">Year Level</label>
          <select class="form-control" id="addStudentYear">
            <option value="1st Year">1st Year</option>
            <option value="2nd Year">2nd Year</option>
            <option value="3rd Year">3rd Year</option>
            <option value="4th Year">4th Year</option>
            <option value="5th Year">5th Year</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="addStudentGender" class="form-label">Gender</label>
          <select class="form-control" id="addStudentGender">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="addStudentProfilePicture" class="form-label">Profile Picture (Optional)</label>
          <input type="file" class="form-control" id="addStudentProfilePicture" accept="image/*">
          <div class="form-text">Accepted formats: PNG, JPG, JPEG, GIF</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addStudent()">Add Student</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content position-relative">
            <div id="editStudentOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="z-index: 10;"></div>
            <div class="modal-header">
                <h5 class="modal-title">Edit Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm" method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="editStudentIdYear" class="form-label">ID Year</label>
                    <input type="number" class="form-control" id="editStudentIdYear">
                </div>
                <div class="mb-3">
                    <label for="editStudentIdNumber" class="form-label">ID Number</label>
                    <input type="text" class="form-control" id="editStudentIdNumber" readonly>
                </div>
                <div class="mb-3">
                    <label for="editStudentFirstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="editStudentFirstName">
                </div>
                <div class="mb-3">
                    <label for="editStudentLastName" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="editStudentLastName">
                </div>
                <div class="mb-3">
                    <label for="editStudentProgram" class="form-label">Program</label>
                    <select class="form-control" id="editStudentProgram">
                        <!-- Programs will be loaded here -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editStudentYear" class="form-label">Year Level</label>
                    <select class="form-control" id="editStudentYear">
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                        <option value="5th Year">5th Year</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editStudentGender" class="form-label">Gender</label>
                    <select class="form-control" id="editStudentGender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editStudentProfilePicture" class="form-label">Profile Picture (Optional)</label>
                    <input type="file" class="form-control" id="editStudentProfilePicture" accept="image/*">
                    <div class="form-text">Accepted formats: PNG, JPG, JPEG, GIF. Leave empty to keep current picture.</div>
                    <div id="currentProfilePicture" class="mt-2"></div>
                    <div id="clearPictureButton" class="mt-2" style="display: none;">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearProfilePicture()">
                            <i class="bi bi-trash"></i> Clear Picture
                        </button>
                    </div>
                </div>
            </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="showUpdateStudentConfirmation()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Confirmation Modal -->
<div class="modal fade" id="updateStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to update this student?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmUpdateStudent()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this student? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteStudent()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="studentProfilePic" class="mb-3">
                    <!-- Profile picture will be inserted here -->
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ID Number:</strong> <span id="studentIdNumber"></span></p>
                        <p><strong>First Name:</strong> <span id="studentFirstName"></span></p>
                        <p><strong>Last Name:</strong> <span id="studentLastName"></span></p>
                        <p><strong>Program Code:</strong> <span id="studentProgramCode"></span></p>
                        <p><strong>Program Name:</strong> <span id="studentProgramName"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>College:</strong> <span id="studentCollegeName"></span></p>
                        <p><strong>Year Level:</strong> <span id="studentYear"></span></p>
                        <p><strong>Gender:</strong> <span id="studentGender"></span></p>
                        <p><strong>Date Registered:</strong> <span id="studentDateRegistered"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentPage = 1;
let currentSearch = '';
let currentSort = 'id';
let totalPages = 1;
let programs = [];

document.addEventListener('DOMContentLoaded', function() {
    loadPrograms();
    loadStudents();

    // Hide overlay when update confirmation modal is closed without confirming
    document.getElementById('updateStudentModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('editStudentOverlay').classList.add('d-none');
    });
});

function loadPrograms() {
    fetch('/api/programs?page=1&per_page=1000')  // Load all programs for select
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                programs = data.data.items;
                populateProgramSelects();
                populateProgramFilter();
            } else {
                console.error('Error loading programs:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function populateProgramSelects() {
    const addSelect = document.getElementById('addStudentProgram');
    const editSelect = document.getElementById('editStudentProgram');
    addSelect.innerHTML = '';
    editSelect.innerHTML = '';
    programs.forEach(program => {
        const option1 = document.createElement('option');
        option1.value = program.code;
        option1.textContent = `${program.code} - ${program.name}`;
        addSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = program.code;
        option2.textContent = `${program.code} - ${program.name}`;
        editSelect.appendChild(option2);
    });
}

function populateProgramFilter() {
    const filterSelect = document.getElementById('programFilter');
    // Clear existing options except "All Programs"
    filterSelect.innerHTML = '<option value="">All Programs</option>';
    programs.forEach(program => {
        const option = document.createElement('option');
        option.value = program.code;
        option.textContent = `${program.code} - ${program.name}`;
        filterSelect.appendChild(option);
    });
}

function loadStudents() {
    const programFilter = document.getElementById('programFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const genderFilter = document.getElementById('genderFilter').value;

    let url = `/api/students?page=${currentPage}&q=${currentSearch}&sort=${currentSort}&per_page=10`;
    if (programFilter) url += `&program_code=${encodeURIComponent(programFilter)}`;
    if (yearFilter) url += `&year=${encodeURIComponent(yearFilter)}`;
    if (genderFilter) url += `&gender=${encodeURIComponent(genderFilter)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderStudents(data.data.items);
                renderPagination(data.data);
                totalPages = data.data.pages;
            } else {
                console.error('Error loading students:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function renderStudents(students) {
    const tbody = document.getElementById('students-tbody');
    tbody.innerHTML = '';

    if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No students found.</td></tr>';
        return;
    }

    students.forEach((student, index) => {
        const profilePic = student.file_link
            ? `<img src="${student.file_link}" alt="Profile" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">`
            : `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-person text-white"></i></div>`;
        const row = `
            <tr onclick="showStudentDetails('${student.id_number}')">
                <th scope="row">${(currentPage - 1) * 10 + index + 1}</th>
                <td>${profilePic}</td>
                <td>${student.id_number}</td>
                <td>${student.first_name} ${student.last_name}</td>
                <td>${student.program_code}</td>
                <td>${student.year}</td>
                <td>${student.gender}</td>
                <td onclick="event.stopPropagation()">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${student.id_number}'); event.stopPropagation();"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id_number}'); event.stopPropagation();"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function renderPagination(data) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage > 1 ? '' : 'disabled'}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous"><span aria-hidden="true">&laquo;</span> Previous</a>`;
    paginationControls.appendChild(prevLi);

    // Page numbers
    for (let i = 1; i <= data.pages; i++) {
        if (i === 1 || i === data.pages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            if (i === currentPage) {
                pageLi.innerHTML = `<span class="page-link editable-page">${i}</span>`;
                attachEditablePageHandler(pageLi.querySelector('.editable-page'));
            } else {
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            }
            paginationControls.appendChild(pageLi);
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationControls.appendChild(ellipsisLi);
        }
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage < data.pages ? '' : 'disabled'}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">Next <span aria-hidden="true">&raquo;</span></a>`;
    paginationControls.appendChild(nextLi);
}

function attachEditablePageHandler(span) {
    span.addEventListener('dblclick', function() {
        const currentPageNum = parseInt(this.textContent);
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentPageNum;
        input.min = 1;
        input.max = totalPages;
        input.className = 'form-control form-control-sm d-inline-block';
        input.style.width = '60px';
        input.style.border = 'none';
        input.style.background = 'transparent';
        input.style.color = '#456882';

        const li = this.parentElement;
        li.innerHTML = '';
        li.appendChild(input);
        input.focus();
        input.select();

        const navigate = () => {
            const newPage = parseInt(input.value);
            if (newPage >= 1 && newPage <= totalPages && newPage !== currentPageNum) {
                changePage(newPage);
            } else {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        };

        input.addEventListener('blur', navigate);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                navigate();
            } else if (e.key === 'Escape') {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        });
    });
}

function changePage(page) {
    currentPage = page;
    loadStudents();
}

function searchStudents() {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 1;
    loadStudents();
}

function sortStudents() {
    currentSort = document.getElementById('sortSelect').value;
    currentPage = 1;
    loadStudents();
}

function applyFilters() {
    currentPage = 1;
    loadStudents();
}

function addStudent() {
    const id_year = document.getElementById('addStudentIdYear').value.trim();
    const id_number = document.getElementById('addStudentIdNumber').value.trim();
    const first_name = document.getElementById('addStudentFirstName').value.trim();
    const last_name = document.getElementById('addStudentLastName').value.trim();
    const program_code = document.getElementById('addStudentProgram').value.trim();
    const year = document.getElementById('addStudentYear').value;
    const gender = document.getElementById('addStudentGender').value.trim();
    const profile_picture = document.getElementById('addStudentProfilePicture').files[0];

    if (!id_number || !first_name || !last_name || !program_code || !year || !gender) {
        showNotification('All fields are required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Create FormData for file upload
    const formData = new FormData();
    formData.append('id_number', id_number);
    formData.append('first_name', first_name);
    formData.append('last_name', last_name);
    formData.append('program_code', program_code);
    formData.append('year', year);
    formData.append('gender', gender);
    if (profile_picture) {
        formData.append('profile_picture', profile_picture);
    }

    fetch('/api/students', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
            document.getElementById('addStudentIdNumber').value = '';
            document.getElementById('addStudentFirstName').value = '';
            document.getElementById('addStudentLastName').value = '';
            document.getElementById('addStudentProfilePicture').value = '';
            loadStudents();
            showNotification('Student added successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while adding the student.', 'danger');
    });
}

function editStudent(id_number) {
    // Fetch student details
    fetch(`/api/students/${encodeURIComponent(id_number)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const student = data.data;
                // Extract year from id_number
                const idParts = student.id_number.split('-');
                const idYear = idParts.length > 0 ? idParts[0] : '';

                document.getElementById('editStudentIdYear').value = idYear;
                document.getElementById('editStudentIdNumber').value = student.id_number;
                document.getElementById('editStudentFirstName').value = student.first_name;
                document.getElementById('editStudentLastName').value = student.last_name;
                document.getElementById('editStudentProgram').value = student.program_code;

                // Set selected for year level
                document.getElementById('editStudentYear').value = student.year;

                // Set selected for gender
                document.getElementById('editStudentGender').value = student.gender;

                // Handle profile picture
                const currentPicDiv = document.getElementById('currentProfilePicture');
                const clearButtonDiv = document.getElementById('clearPictureButton');
                if (student.file_link) {
                    currentPicDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${student.file_link}" alt="Current Profile" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            <small class="text-muted">Current profile picture</small>
                        </div>
                    `;
                    clearButtonDiv.style.display = 'block';
                } else {
                    currentPicDiv.innerHTML = '<small class="text-muted">No profile picture uploaded</small>';
                    clearButtonDiv.style.display = 'none';
                }
                document.getElementById('editStudentProfilePicture').value = '';
                // Reset clear flag
                document.getElementById('editStudentModal').dataset.clearPicture = 'false';

                document.getElementById('editStudentModal').dataset.originalId = id_number;
                new bootstrap.Modal(document.getElementById('editStudentModal')).show();
            } else {
                showNotification(data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while fetching student details.', 'danger');
        });
}

function updateStudent() {
    const originalId = document.getElementById('editStudentModal').dataset.originalId;
    const id_number = document.getElementById('editStudentIdNumber').value.trim();
    const first_name = document.getElementById('editStudentFirstName').value.trim();
    const last_name = document.getElementById('editStudentLastName').value.trim();
    const program_code = document.getElementById('editStudentProgram').value.trim();
    const year = document.getElementById('editStudentYear').value;
    const gender = document.getElementById('editStudentGender').value.trim();
    const profile_picture = document.getElementById('editStudentProfilePicture').files[0];

    if (!id_number || !first_name || !last_name || !program_code || !year || !gender) {
        showNotification('All fields are required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Use FormData if there's a file, otherwise use JSON
    let body;
    let headers = {
        'X-CSRFToken': csrfToken,
    };

    const clearPicture = document.getElementById('editStudentModal').dataset.clearPicture === 'true';

    if (profile_picture) {
        // Use FormData for file upload
        const formData = new FormData();
        formData.append('id_number', id_number);
        formData.append('first_name', first_name);
        formData.append('last_name', last_name);
        formData.append('program_code', program_code);
        formData.append('year', year);
        formData.append('gender', gender);
        formData.append('profile_picture', profile_picture);
        if (clearPicture) {
            formData.append('clear_picture', 'True');
        }
        body = formData;
        // Don't set Content-Type for FormData, let browser set it with boundary
    } else {
        // Use JSON for non-file updates
        headers['Content-Type'] = 'application/json';
        body = JSON.stringify({ id_number, first_name, last_name, program_code, year, gender, clear_picture: clearPicture });
    }

    fetch(`/api/students/${encodeURIComponent(originalId)}`, {
        method: 'PUT',
        headers: headers,
        body: body,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
            loadStudents();
            showNotification('Student updated successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the student.', 'danger');
    });
}

function showUpdateStudentConfirmation() {
    document.getElementById('editStudentOverlay').classList.remove('d-none');
    new bootstrap.Modal(document.getElementById('updateStudentModal')).show();
}

function confirmUpdateStudent() {
    bootstrap.Modal.getInstance(document.getElementById('updateStudentModal')).hide();
    document.getElementById('editStudentOverlay').classList.add('d-none');
    updateStudent();
}

function deleteStudent(id_number) {
    document.getElementById('deleteStudentModal').dataset.deleteId = id_number;
    new bootstrap.Modal(document.getElementById('deleteStudentModal')).show();
}

function confirmDeleteStudent() {
    const id_number = document.getElementById('deleteStudentModal').dataset.deleteId;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/api/students/${encodeURIComponent(id_number)}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteStudentModal')).hide();
            loadStudents();
            showNotification('Student deleted successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the student.', 'danger');
    });
}

// Auto-generate ID when year changes
document.getElementById('addStudentIdYear').addEventListener('input', function() {
    const year = this.value.trim();
    if (year) {
        fetch(`/api/students/next-id/${year}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('addStudentIdNumber').value = data.data.next_id;
                }
            })
            .catch(error => console.error('Error fetching next ID:', error));
    }
});

// Auto-update ID when year changes in edit modal
document.getElementById('editStudentIdYear').addEventListener('input', function() {
    const year = this.value.trim();
    const currentId = document.getElementById('editStudentIdNumber').value;
    if (currentId && year) {
        const idParts = currentId.split('-');
        if (idParts.length > 1) {
            const numPart = idParts.slice(1).join('-');
            document.getElementById('editStudentIdNumber').value = year + '-' + numPart;
        }
    }
});

// Set default year on load
document.addEventListener('DOMContentLoaded', function() {
    const currentYear = new Date().getFullYear();
    document.getElementById('addStudentIdYear').value = currentYear;
    // Trigger the input event to generate the ID
    document.getElementById('addStudentIdYear').dispatchEvent(new Event('input'));
});

function showStudentDetails(id_number) {
    fetch(`/api/students/${encodeURIComponent(id_number)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const student = data.data;

                // Set profile picture
                const profilePicDiv = document.getElementById('studentProfilePic');
                if (student.file_link) {
                    profilePicDiv.innerHTML = `<img src="${student.file_link}" alt="Profile Picture" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">`;
                } else {
                    profilePicDiv.innerHTML = `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;"><i class="bi bi-person text-white" style="font-size: 2rem;"></i></div>`;
                }

                // Populate fields
                document.getElementById('studentIdNumber').textContent = student.id_number;
                document.getElementById('studentFirstName').textContent = student.first_name;
                document.getElementById('studentLastName').textContent = student.last_name;
                document.getElementById('studentProgramCode').textContent = student.program_code;
                document.getElementById('studentProgramName').textContent = student.program_name || 'N/A';
                document.getElementById('studentCollegeName').textContent = student.college_name || 'N/A';
                document.getElementById('studentYear').textContent = student.year;
                document.getElementById('studentGender').textContent = student.gender;
                document.getElementById('studentDateRegistered').textContent = new Date(student.date_registered).toLocaleDateString();

                // Show modal
                new bootstrap.Modal(document.getElementById('studentDetailsModal')).show();
            } else {
                showNotification(data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while fetching student details.', 'danger');
        });
}

function clearProfilePicture() {
    // Set the clear flag
    document.getElementById('editStudentModal').dataset.clearPicture = 'true';

    // Hide the current picture display and clear button
    document.getElementById('currentProfilePicture').innerHTML = '<small class="text-muted">Picture will be cleared</small>';
    document.getElementById('clearPictureButton').style.display = 'none';

    // Clear the file input
    document.getElementById('editStudentProfilePicture').value = '';

    showNotification('Profile picture will be cleared when you update the student.', 'info');
}

function showNotification(message, type) {
    const container = document.getElementById('notification-container');
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `
        <span class="close-btn">&times;</span>
        <h6>${type.charAt(0).toUpperCase() + type.slice(1)}</h6>
        <p>${message}</p>
    `;
    container.appendChild(notif);

    notif.querySelector('.close-btn').addEventListener('click', () => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    });

    setTimeout(() => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}
</script>

    {% endblock %}
