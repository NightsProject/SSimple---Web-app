{% extends "layouts/base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="card">
    <div class="card-body">

  <div class="d-flex justify-content-between align-items-center mb-3">

    <!-- Left side: New Program button + Search -->
    <div class="d-flex align-items-center">
      <!-- New Program Button (opens modal) -->
      <button class="btn btn-success me-3" data-bs-toggle="modal" data-bs-target="#addProgramModal" id="addProgramBtn">
        Add Program
      </button>

      <!-- Search -->
      <div class="d-flex" role="search">
        <input class="form-control me-2"
              type="search"
              placeholder="Search Programs..."
              id="searchInput"
              value="">
        <button class="btn btn-outline-primary" type="button" onclick="searchPrograms()">Search</button>
      </div>
    </div>

    <!-- Sort -->
    <select class="form-select" id="sortSelect" onchange="sortPrograms()">
      <option value="code">Sort by Code</option>
      <option value="name">Sort by Name</option>
    </select>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Code</th>
          <th scope="col">Name</th>
          <th scope="col">College</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="programs-tbody">
        <!-- Programs will be loaded here via JS -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls">
      <!-- Pagination will be generated here via JS -->
    </ul>
  </nav>
    </div>
  </div>
</div>

<!-- ðŸŸ¢ Modal: Add Program -->
<div class="modal fade" id="addProgramModal" tabindex="-1" aria-labelledby="addProgramModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addProgramModalLabel">Add New Program</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="addProgramCode" class="form-label">Code</label>
          <input type="text" class="form-control" id="addProgramCode" placeholder="e.g., BSCS">
        </div>
        <div class="mb-3">
          <label for="addProgramName" class="form-label">Name</label>
          <input type="text" class="form-control" id="addProgramName" placeholder="e.g., Bachelor of Science in Computer Science">
        </div>
        <div class="mb-3">
          <label for="addProgramCollege" class="form-label">College</label>
          <select class="form-control" id="addProgramCollege">
            <!-- Colleges will be loaded here -->
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addProgram()">Add Program</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Program Modal -->
<div class="modal fade" id="editProgramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content position-relative">
            <div id="editProgramOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="z-index: 10;"></div>
            <div class="modal-header">
                <h5 class="modal-title">Edit Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editProgramCode" class="form-label">Code</label>
                    <input type="text" class="form-control" id="editProgramCode">
                </div>
                <div class="mb-3">
                    <label for="editProgramName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="editProgramName">
                </div>
                <div class="mb-3">
                    <label for="editProgramCollege" class="form-label">College</label>
                    <select class="form-control" id="editProgramCollege">
                        <!-- Colleges will be loaded here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="showUpdateProgramConfirmation()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Confirmation Modal -->
<div class="modal fade" id="updateProgramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to update this program?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmUpdateProgram()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProgramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this program? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteProgram()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentPage = 1;
let currentSearch = '';
let currentSort = 'code';
let totalPages = 1;
let colleges = [];

document.addEventListener('DOMContentLoaded', function() {
    loadColleges();
    loadPrograms();
});

function loadColleges() {
    fetch('/api/colleges?page=1&per_page=1000')  // Load all colleges for select
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                colleges = data.data.items;
                populateCollegeSelects();
                if (colleges.length === 0) {
                    document.getElementById('addProgramBtn').disabled = true;
                    document.getElementById('addProgramBtn').title = 'Add a college first';
                }
            } else {
                console.error('Error loading colleges:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function populateCollegeSelects() {
    const addSelect = document.getElementById('addProgramCollege');
    const editSelect = document.getElementById('editProgramCollege');
    addSelect.innerHTML = '';
    editSelect.innerHTML = '';
    colleges.forEach(college => {
        const option1 = document.createElement('option');
        option1.value = college.code;
        option1.textContent = `${college.code} - ${college.name}`;
        addSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = college.code;
        option2.textContent = `${college.code} - ${college.name}`;
        editSelect.appendChild(option2);
    });
}

function loadPrograms() {
    fetch(`/api/programs?page=${currentPage}&q=${currentSearch}&sort=${currentSort}&per_page=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPrograms(data.data.items);
                renderPagination(data.data);
                totalPages = data.data.pages;
            } else {
                console.error('Error loading programs:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function renderPrograms(programs) {
    const tbody = document.getElementById('programs-tbody');
    tbody.innerHTML = '';

    if (programs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No programs found.</td></tr>';
        return;
    }

    programs.forEach((program, index) => {
        const row = `
            <tr>
                <th scope="row">${(currentPage - 1) * 10 + index + 1}</th>
                <td>${program.code}</td>
                <td>${program.name}</td>
                <td>${program.college_name || program.college_code || '-'}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="editProgram('${program.code}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProgram('${program.code}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function renderPagination(data) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage > 1 ? '' : 'disabled'}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous"><span aria-hidden="true">&laquo;</span> Previous</a>`;
    paginationControls.appendChild(prevLi);

    // Page numbers
    for (let i = 1; i <= data.pages; i++) {
        if (i === 1 || i === data.pages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            if (i === currentPage) {
                pageLi.innerHTML = `<span class="page-link editable-page">${i}</span>`;
                attachEditablePageHandler(pageLi.querySelector('.editable-page'));
            } else {
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            }
            paginationControls.appendChild(pageLi);
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationControls.appendChild(ellipsisLi);
        }
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage < data.pages ? '' : 'disabled'}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">Next <span aria-hidden="true">&raquo;</span></a>`;
    paginationControls.appendChild(nextLi);
}

function attachEditablePageHandler(span) {
    span.addEventListener('dblclick', function() {
        const currentPageNum = parseInt(this.textContent);
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentPageNum;
        input.min = 1;
        input.max = totalPages;
        input.className = 'form-control form-control-sm d-inline-block';
        input.style.width = '60px';
        input.style.border = 'none';
        input.style.background = 'transparent';
        input.style.color = '#456882';

        const li = this.parentElement;
        li.innerHTML = '';
        li.appendChild(input);
        input.focus();
        input.select();

        const navigate = () => {
            const newPage = parseInt(input.value);
            if (newPage >= 1 && newPage <= totalPages && newPage !== currentPageNum) {
                changePage(newPage);
            } else {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        };

        input.addEventListener('blur', navigate);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                navigate();
            } else if (e.key === 'Escape') {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        });
    });
}

function changePage(page) {
    currentPage = page;
    loadPrograms();
}

function searchPrograms() {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 1;
    loadPrograms();
}

function sortPrograms() {
    currentSort = document.getElementById('sortSelect').value;
    currentPage = 1;
    loadPrograms();
}

function addProgram() {
    const code = document.getElementById('addProgramCode').value.trim();
    const name = document.getElementById('addProgramName').value.trim();
    const college_code = document.getElementById('addProgramCollege').value.trim();

    if (!code || !name || !college_code) {
        showNotification('Code, name, and college are required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/programs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ code, name, college_code }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addProgramModal')).hide();
            document.getElementById('addProgramCode').value = '';
            document.getElementById('addProgramName').value = '';
            loadPrograms();
            showNotification('Program added successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while adding the program.', 'danger');
    });
}

function editProgram(code) {
    // Fetch program details
    fetch(`/api/programs/${code}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('editProgramCode').value = data.data.code;
                document.getElementById('editProgramName').value = data.data.name;
                document.getElementById('editProgramCollege').value = data.data.college_code;
                document.getElementById('editProgramModal').dataset.originalCode = code;
                new bootstrap.Modal(document.getElementById('editProgramModal')).show();
            } else {
                showNotification(data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while fetching program details.', 'danger');
        });
}

function updateProgram() {
    const originalCode = document.getElementById('editProgramModal').dataset.originalCode;
    const code = document.getElementById('editProgramCode').value.trim();
    const name = document.getElementById('editProgramName').value.trim();
    const college_code = document.getElementById('editProgramCollege').value.trim();

    if (!code || !name || !college_code) {
        showNotification('Code, name, and college are required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/api/programs/${originalCode}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ code, name, college_code }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editProgramModal')).hide();
            loadPrograms();
            showNotification('Program updated successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the program.', 'danger');
    });
}

function deleteProgram(code) {
    document.getElementById('deleteProgramModal').dataset.deleteCode = code;
    new bootstrap.Modal(document.getElementById('deleteProgramModal')).show();
}

function confirmDeleteProgram() {
    const code = document.getElementById('deleteProgramModal').dataset.deleteCode;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/api/programs/${code}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteProgramModal')).hide();
            loadPrograms();
            showNotification('Program deleted successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the program.', 'danger');
    });
}

function showNotification(message, type) {
    const container = document.getElementById('notification-container');
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `
        <span class="close-btn">&times;</span>
        <h6>${type.charAt(0).toUpperCase() + type.slice(1)}</h6>
        <p>${message}</p>
    `;
    container.appendChild(notif);

    notif.querySelector('.close-btn').addEventListener('click', () => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    });

    setTimeout(() => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}
</script>

    {% endblock %}
