{% extends "layouts/base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="card">
    <div class="card-body">

  <div class="d-flex justify-content-between align-items-center mb-3">

    <!-- Left side: New College button + Search -->
    <div class="d-flex align-items-center">
      <!-- New College Button (opens modal) -->
      <button class="btn btn-success me-3" data-bs-toggle="modal" data-bs-target="#addCollegeModal">
        Add College
      </button>

      <!-- Search -->
      <div class="d-flex" role="search">
        <input class="form-control me-2"
              type="search"
              placeholder="Search Colleges..."
              id="searchInput"
              value="">
        <button class="btn btn-outline-primary" type="button" onclick="searchColleges()">Search</button>
      </div>
    </div>

    <!-- Sort -->
    <select class="form-select" id="sortSelect" onchange="sortColleges()">
      <option value="code">Sort by Code</option>
      <option value="name">Sort by Name</option>
    </select>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Code</th>
          <th scope="col">Name</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="colleges-tbody">
        <!-- Colleges will be loaded here via JS -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls">
      <!-- Pagination will be generated here via JS -->
    </ul>
  </nav>
    </div>
  </div>
</div>

<!-- ðŸŸ¢ Modal: Add College -->
<div class="modal fade" id="addCollegeModal" tabindex="-1" aria-labelledby="addCollegeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addCollegeModalLabel">Add New College</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="addCollegeCode" class="form-label">Code</label>
          <input type="text" class="form-control" id="addCollegeCode" placeholder="e.g., CC">
        </div>
        <div class="mb-3">
          <label for="addCollegeName" class="form-label">Name</label>
          <input type="text" class="form-control" id="addCollegeName" placeholder="e.g., College of Computing">
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addCollege()">Add College</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit College Modal -->
<div class="modal fade" id="editCollegeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content position-relative">
            <div id="editCollegeOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="z-index: 10;"></div>
            <div class="modal-header">
                <h5 class="modal-title">Edit College</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editCollegeCode" class="form-label">Code</label>
                    <input type="text" class="form-control" id="editCollegeCode">
                </div>
                <div class="mb-3">
                    <label for="editCollegeName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="editCollegeName">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="showUpdateCollegeConfirmation()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Confirmation Modal -->
<div class="modal fade" id="updateCollegeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to update this college?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmUpdateCollege()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCollegeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete College</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this college? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCollege()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentPage = 1;
let currentSearch = '';
let currentSort = 'code';
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    loadColleges();

    // Hide overlay when update confirmation modal is closed without confirming
    document.getElementById('updateCollegeModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('editCollegeOverlay').classList.add('d-none');
    });
});

function loadColleges() {
    fetch(`/api/colleges?page=${currentPage}&q=${currentSearch}&sort=${currentSort}&per_page=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderColleges(data.data.items);
                renderPagination(data.data);
                totalPages = data.data.pages;
            } else {
                console.error('Error loading colleges:', data.error);
            }
        })
        .catch(error => console.error('Error:', error));
}

function renderColleges(colleges) {
    const tbody = document.getElementById('colleges-tbody');
    tbody.innerHTML = '';

    if (colleges.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No colleges found.</td></tr>';
        return;
    }

    colleges.forEach((college, index) => {
        const row = `
            <tr>
                <th scope="row">${(currentPage - 1) * 10 + index + 1}</th>
                <td>${college.code}</td>
                <td>${college.name}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning" onclick="editCollege('${college.code}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCollege('${college.code}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function renderPagination(data) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage > 1 ? '' : 'disabled'}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous"><span aria-hidden="true">&laquo;</span> Previous</a>`;
    paginationControls.appendChild(prevLi);

    // Page numbers
    for (let i = 1; i <= data.pages; i++) {
        if (i === 1 || i === data.pages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            if (i === currentPage) {
                pageLi.innerHTML = `<span class="page-link editable-page">${i}</span>`;
                attachEditablePageHandler(pageLi.querySelector('.editable-page'));
            } else {
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            }
            paginationControls.appendChild(pageLi);
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationControls.appendChild(ellipsisLi);
        }
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage < data.pages ? '' : 'disabled'}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">Next <span aria-hidden="true">&raquo;</span></a>`;
    paginationControls.appendChild(nextLi);
}

function attachEditablePageHandler(span) {
    span.addEventListener('dblclick', function() {
        const currentPageNum = parseInt(this.textContent);
        const input = document.createElement('input');
        input.type = 'number';
        input.value = currentPageNum;
        input.min = 1;
        input.max = totalPages;
        input.className = 'form-control form-control-sm d-inline-block';
        input.style.width = '60px';
        input.style.border = 'none';
        input.style.background = 'transparent';
        input.style.color = '#456882';

        const li = this.parentElement;
        li.innerHTML = '';
        li.appendChild(input);
        input.focus();
        input.select();

        const navigate = () => {
            const newPage = parseInt(input.value);
            if (newPage >= 1 && newPage <= totalPages && newPage !== currentPageNum) {
                changePage(newPage);
            } else {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        };

        input.addEventListener('blur', navigate);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                navigate();
            } else if (e.key === 'Escape') {
                li.innerHTML = '<span class="page-link editable-page">' + currentPageNum + '</span>';
                attachEditablePageHandler(li.querySelector('.editable-page'));
            }
        });
    });
}

function changePage(page) {
    currentPage = page;
    loadColleges();
}

function searchColleges() {
    currentSearch = document.getElementById('searchInput').value;
    currentPage = 1;
    loadColleges();
}

function sortColleges() {
    currentSort = document.getElementById('sortSelect').value;
    currentPage = 1;
    loadColleges();
}

function addCollege() {
    const code = document.getElementById('addCollegeCode').value.trim();
    const name = document.getElementById('addCollegeName').value.trim();

    if (!code || !name) {
        showNotification('Code and name are required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/colleges', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ code, name }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addCollegeModal')).hide();
            document.getElementById('addCollegeCode').value = '';
            document.getElementById('addCollegeName').value = '';
            loadColleges();
            showNotification('College added successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while adding the college.', 'danger');
    });
}

function editCollege(code) {
    // Fetch college details
    fetch(`/api/colleges/${code}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('editCollegeCode').value = data.data.code;
                document.getElementById('editCollegeName').value = data.data.name;
                document.getElementById('editCollegeModal').dataset.originalCode = code;
                new bootstrap.Modal(document.getElementById('editCollegeModal')).show();
            } else {
                showNotification(data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while fetching college details.', 'danger');
        });
}

function updateCollege() {
    const originalCode = document.getElementById('editCollegeModal').dataset.originalCode;
    const code = document.getElementById('editCollegeCode').value.trim();
    const name = document.getElementById('editCollegeName').value.trim();

    if (!name) {
        showNotification('Name is required.', 'danger');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/api/colleges/${originalCode}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ code, name }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editCollegeModal')).hide();
            loadColleges();
            showNotification('College updated successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while updating the college.', 'danger');
    });
}

function showUpdateCollegeConfirmation() {
    document.getElementById('editCollegeOverlay').classList.remove('d-none');
    new bootstrap.Modal(document.getElementById('updateCollegeModal')).show();
}

function confirmUpdateCollege() {
    bootstrap.Modal.getInstance(document.getElementById('updateCollegeModal')).hide();
    document.getElementById('editCollegeOverlay').classList.add('d-none');
    updateCollege();
}

function deleteCollege(code) {
    document.getElementById('deleteCollegeModal').dataset.deleteCode = code;
    new bootstrap.Modal(document.getElementById('deleteCollegeModal')).show();
}

function confirmDeleteCollege() {
    const code = document.getElementById('deleteCollegeModal').dataset.deleteCode;

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/api/colleges/${code}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteCollegeModal')).hide();
            loadColleges();
            showNotification('College deleted successfully!', 'success');
        } else {
            showNotification(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while deleting the college.', 'danger');
    });
}

function showNotification(message, type) {
    const container = document.getElementById('notification-container');
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `
        <span class="close-btn">&times;</span>
        <h6>${type.charAt(0).toUpperCase() + type.slice(1)}</h6>
        <p>${message}</p>
    `;
    container.appendChild(notif);

    notif.querySelector('.close-btn').addEventListener('click', () => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    });

    setTimeout(() => {
        notif.style.animation = 'fadeOut 0.3s forwards';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}
</script>

    {% endblock %}

